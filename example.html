<!DOCTYPE html>

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title></title>
		<script type="text/javascript" src="simplepeer.js"></script>
	</head>
  <body>
    <div id="listOfOffers" style="border: 1px solid red;">

    </div>

    <button id="sendMessage">Send Message</button>
  </body>
  <script>

  var g_offer = null;
  var g_answer = null;
  var is_initiator = location.hash === '#1';

  var wsAddress = 'ws://' + document.URL.split('://')[1].split(':')[0] + ':8888';
  console.info(wsAddress);
  var ws = new WebSocket(wsAddress, 'peer-protocol');

  // Get all offer when we connect to the WebSocket
  ws.addEventListener('open', function(message) {
    if (! is_initiator) {
      ws.send(JSON.stringify({type: 'get_offers', offer: JSON.stringify(g_offer)}));
    }
  });

  ws.addEventListener('message', function(message) {
    var data = JSON.parse(message.data);
    //console.info(JSON.stringify(message));
    switch (data.type) {
      case 'get_offers':
        var listOfOffers = document.querySelector('#listOfOffers');
        listOfOffers.innerHTML = '';
        for (var i=0; i<data.offers.length; ++i) {
          var offer = JSON.parse(data.offers[i]);
          var a = document.createElement('a');
          a.href = '#';
          a.innerHTML = JSON.stringify(offer);
          a.addEventListener('click', function(e) {
              e.preventDefault();
              g_offer = offer;
              console.info(JSON.stringify(g_offer));
              peer.signal(g_offer);
          });
          listOfOffers.appendChild(a);
        }
        break;
      case 'get_answer':
        g_answer = JSON.parse(data.answer);
        //console.info(JSON.stringify(g_answer));
        peer.signal(g_answer);
        break;
      default:
        console.error('Unknown message type.');
        console.error(data.type);
    }
  });

  var peer = new SimplePeer({ initiator: is_initiator, trickle: false })

  peer.on('error', function (err) {
    console.log('error', err);
  });

  peer.on('signal', function (data) {
    console.log('SIGNAL', JSON.stringify(data));

    if (is_initiator) {
      g_offer = data;
      ws.send(JSON.stringify({type: 'set_offer', offer: JSON.stringify(g_offer)}));
    } else {
      g_answer = data;
      ws.send(JSON.stringify({type: 'set_answer', answer: JSON.stringify(g_answer), offer: JSON.stringify(g_offer)}));
    }
  });

  peer.on('connect', function () {
    console.log('CONNECT');
    peer.send('whatever' + Math.random());
  });

  peer.on('data', function (data) {
    console.log('data: ' + data);
  });

  document.querySelector('#sendMessage').addEventListener('click', function(e) {
    peer.send('whatever' + Math.random());
  });
  </script>
</html>
