<!DOCTYPE html>

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title></title>
		<script type="text/javascript" src="simplepeer.js"></script>
	</head>
  <body>
    <div>
      <button id="getAnswer">(2) Get Answer</button>
      <br />
      <textarea id="offer"></textarea>
    </div>

    <div>
      <button id="getOffer">(1) Get Offer</button>
      <br />
      <textarea id="answer"></textarea>
    </div>

    <button id="sendMessage">Send Message</button>
  </body>
  <script>
  function httpGetJSON(url, cb, timeout) {
  	timeout = timeout || 3000;
  	var xhr = new XMLHttpRequest();
  	xhr.onreadystatechange = function() {
  		if (this.readyState === 4) {
  			cb(this.response, this.status);
  		} else if (this.readyState === 0) {
  			cb(null);
  		}
  	};
  	xhr.onerror = function() {
  		cb(null);
  	};
  	xhr.open('GET', url, true);
  	xhr.responseType = 'json';
  	xhr.timeout = timeout;
  	xhr.send(null);
  }


  var httpServer = 'http://' + document.URL.split('://')[1].split(':')[0] + ':8888';
  console.info(httpServer);

  var g_offer = null;
  var g_answer = null;
  var is_initiator = location.hash === '#1';
  var peer = new SimplePeer({ initiator: is_initiator, trickle: false })

  peer.on('error', function (err) {
    console.log('error', err);
  });

  peer.on('signal', function (data) {
    console.log('SIGNAL', JSON.stringify(data));

    if (is_initiator) {
      g_offer = data;
      var enc_offer = encodeURIComponent(btoa(JSON.stringify(g_offer)));
      httpGetJSON(httpServer + '/set_offer.json?offer=' + enc_offer, function(response, status) {
          if (status !== 200) {
              console.error('offer failed with status: ' + status);
          }
      });
    } else {
      g_answer = data;
      var enc_answer = encodeURIComponent(btoa(JSON.stringify(g_answer)));
      var enc_offer = encodeURIComponent(btoa(JSON.stringify(g_offer)));
      httpGetJSON(httpServer + '/set_answer.json?answer=' + enc_answer + '&offer=' + enc_offer, function(response, status) {
          if (status !== 200) {
              console.error('answer failed .....');
          }
      });
    }
  });

  peer.on('connect', function () {
    console.log('CONNECT');
    peer.send('whatever' + Math.random());
  });

  peer.on('data', function (data) {
    console.log('data: ' + data);
  });

  document.querySelector('#sendMessage').addEventListener('click', function(e) {
    peer.send('whatever' + Math.random());
  });

  document.querySelector('#getOffer').addEventListener('click', function(e) {
    httpGetJSON(httpServer + '/get_offers.json', function(response, status) {
        if (status === 200) {
            var offer = response[0];
            g_offer = JSON.parse(atob(decodeURIComponent(offer)));
            console.info(g_offer);
            peer.signal(g_offer);

        } else {
            console.error('offer failed .....');
        }
    });
  });

  document.querySelector('#getAnswer').addEventListener('click', function(e) {
    var enc_offer = encodeURIComponent(btoa(JSON.stringify(g_offer)));
    httpGetJSON(httpServer + '/get_answer.json?offer=' + enc_offer, function(response, status) {
        if (status === 200) {
            g_answer = JSON.parse(atob(decodeURIComponent(response)));
            console.info(g_answer);
            peer.signal(g_answer);
        } else {
            console.error('offer failed .....');
        }
    });
  });
  </script>
</html>
